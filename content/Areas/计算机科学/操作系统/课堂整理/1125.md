

- **上节课知识回顾**

- **磁盘性能优化**

- 减少磁盘访问：为提升文件系统性能，需尽量减少磁盘访问，可将数据放在内存中。同时，考虑让磁盘变快，如进行磁道调度。

- 磁道调度分析：磁道调度虽在说话人1的考试中可能不重要，但在其他考试中出现频度较高。其目的是减少磁臂移动和掉头，合理安排磁道和扇区号读写顺序。不过，随着智能硬件发展，磁盘自身有控制器、CPU 和内存，可对指令重排序，磁头调度作用有所变化。

- **磁盘与内存相似性及 RAID 技术**：磁盘和内存都涉及对连续存储空间的管理，为优化性能，采用了 RAID 技术。目前常见的 RAID 磁盘阵列如双盘备份，成本相对较低，多盘片机柜成本较高，但能提升性能。

- **文件系统相关问题**

- 文件摆放与数据排布：作为磁盘和文件系统使用者，为最大化磁盘性能，需解决文件摆放和数据排布问题。上节课通过间接索引结构解决了文件在磁盘上的摆放问题，接下来探讨文件内容的读取格式。

- 文件格式与 MMAP：介绍了 ELF 格式，强调 MMAP 对加速程序读取和解决虚拟地址空间问题的重要性。同时指出磁盘上数据多于程序，ELF 格式改进较少。

- 数据存储与读取格式：上节课简单演示了数据库（b + 树）和音视频（连续数据流）的存储和读取格式。以视频流为例，分析了文件系统顺序读取与磁盘实际读取的关系，引出磁盘碎片整理概念。

- 磁盘配额统计问题：操作系统设计者需知道每个用户占据磁盘的大小，以便正确收费。但磁盘遍历耗时，因此磁盘配额统计是个有趣的问题，如百度网盘服务器需解决此问题，而 Windows 作为单用户系统无需响应。

- VFS 概念与意义：VFS 是面向对象技术在操作系统中的体现，是开源社区的胜利。它为不同文件系统提供统一接口，最终成为事实上的标准。VFS 还免费提供配置 cache 的机制和 negative cache 优化技术，对感兴趣的同学有研究价值。

- **触摸屏原理讲解**

- **电阻屏工作原理**

- 电压与位置关系：电阻屏由两层透明材料组成，下层均匀分布电阻，上层为零电阻柔软材料。通过给下层施加电压，根据位置与电压的线性关系，可确定触摸位置的电压，进而计算出位置。

- 坐标测量方法：用尖物戳电阻屏时，上下层短路，通过在特定位置接电压表测量电压，经 AD 转换器将电压值换算成距离，可得到触摸点的横向和纵向坐标。为确保在用户触摸时同时测量 x 向和 y 向坐标，需在短时间内完成电压施加、测量和清除操作，利用人的反应时间特点实现坐标获取。

- **电容屏工作原理**

- 电容充放电模式：电容屏底板上的小方格可看作小电容，有充电和放电两种模式。当人手触摸时，会改变周边电容的电量。

- 坐标检测方式：通过控制器扫描每个电容上的电压变化，确定触摸位置的坐标。同时解释了电容屏可实现多点触，而电阻屏难以实现的原因。

- **计算机与外部设备连接及数据传输**

- **设备与 CPU 连接问题**

- 设备逻辑复杂度差异：早期计算机设备简单，如键盘可直接转化成高低电平，与 CPU 连接逻辑简单。而触摸屏等设备需要复杂逻辑，如在一毫秒内完成电压施加、测量等操作。

- 外包处理设备逻辑：为减轻 CPU 负担，采用外包方式，使用小芯片控制触摸屏逻辑，周期性扫描屏幕。当屏幕有触摸事件发生时，通过中断通知 CPU，并通过数据读写接口传输坐标数据。

- **设备与 CPU 通信接口**

- 物理与逻辑连接需求：设备需通过内部控制器将采集信息整理成能与 CPU 直接相连的接口，完成与 CPU 的通信。强调物理上电路连接和逻辑上数据传输的重要性。

- 寄存器概念与作用：设备通常会暴露内部存储器作为寄存器，用于存储采集的数据，如 x、y 坐标、网络数据包等。寄存器分为数据、控制和状态三类，分别用于数据传输、接收 CPU 命令和查询设备状态。

- **计算机与设备连接方式**

- 总线连接方案演变：早期将设备控制器的 SRAM 与 CPU 的数据总线和地址总线连接，但因 CPU 与 IO 设备速度差异大，对总线压力高，于是将指令分为内存读写和 IO 读写两类，采用独立的 IO 总线和内存总线。后来，为简化设计，将所有对外部的读写统一到一套指令，使用一条总线，将 IO 设备内存映射到 CPU 地址空间。

- 地址空间分配现状：以 80386 地址空间为例，说明地址空间被不同设备占用的情况，如显存、Pcie 总线等，反映出计算机设计的历史演变和现状。

- **解决 CPU 与外部设备速度差异问题**

- 引入高速总线控制设备：为避免 CPU 适配慢速外部设备，配套高速总线控制设备，如 USB 控制器。USB 控制器可预先将数据从外部设备搬运到其内存，再通知 CPU 读取，提高数据传输效率。

- IO 指令权限问题：IO 指令原本为用户态指令，但在现代处理器和操作系统中，进入保护模式后 IO 指令失效。为保护设备暴露的存储区，需将其映射到内核地址空间，由操作系统管理。

- 设备驱动程序权限与效率问题：设备驱动程序作为操作系统一部分，拥有高权限，但可能由设备厂商编写，存在安全风险。同时，内核态运行程序存在效率问题，部分高性能设备将相关空间映射到用户态，但会带来安全隐患。

- **数据传输方式与 DMA 技术**

- **数据传输方案分析**

- 三种数据传输模式：提出三种数据传输模式，即轮询、中断和 DMA。轮询是 CPU 循环等待设备状态变化；中断是设备有数据变化时通知 CPU；DMA 是专用设备替 CPU 完成连续内存操作。

- 方案选择与问题探讨：分析了三种模式的优缺点，并探讨了未提及的轮询 + DMA 方案为何不合理。同时指出在不同设备速度下，应选择合适的发现数据传输方法和数据传输方法。

- **DMA 原理与问题**

- DMA 功能与作用：DMA 可像 CPU 一样产生内存总线上的读写信号，代替 CPU 完成内存读写操作，如从磁盘往内存拷数据等。利用 DMA 完成 Memcopy 是今年操作系统顶会 best paper 的思路。

- DMA 面临的问题：存在 CPU 与 DMA 对内存访问冲突问题，需协调两者使用内存的时间。同时，DMA 控制器无法直接访问用户虚拟地址空间对应的物理地址，因在 80386 时代 DMA 控制器与 CPU 相互独立，且用户发起数据读取操作时处于阻塞态，MMU 上的页表情况复杂。

- DMA 数据传输过程与问题：DMA 数据传输需将数据多次复制和拷贝，浪费时间和存储空间。为解决此问题，出现了 RDMA 技术，其可跳过中间环节，直接访问用户空间，但需要操作系统和新式网卡配合。

- **网络数据传输优化**

- **中断与轮询选择**

- 高速设备下的问题：在高速设备中，使用中断模式传输数据会导致系统频繁中断，CPU 无法正常工作，因数据传输速度远高于 CPU 处理速度。

- 轮询与 DMA 组合方案：采用轮询 + DMA 组合方案，通过 CPU 轮询网络传输状态，利用 DMA 进行数据传输，可减少中断和上下文切换，提高运行效率。

- **RDMA 技术优势**：RDMA 技术为解决网络数据传输中数据多次复制和拷贝问题，可直接访问用户空间，减少时间和存储浪费，提高数据传输效率。

- **设备驱动程序开发与设备管理**

- **统一接口需求**

- 降低开发复杂度：为降低应用程序开发者复杂度，不希望他们为每款设备适配程序，因此需要为不同设备提供统一接口，使应用程序能响应不同厂商的设备。

- 设备实例化接口：举例说明不同指点型设备（触摸屏、触摸板、轨迹球、鼠标等）和扫码枪都可使用统一接口传输数据，新设备可沿用已存在的接口上传数据。

- **设备管理分层**：为避免设备之间的差异性，将设备管理分为两层，一层是抽象类，为上层提供统一接口；另一层是具体实现层，负责从设备中搬运数据。

- **设备驱动程序开发示例**

- 触摸屏驱动程序实现：以触摸屏为例，说明设备驱动程序的开发过程。触摸屏产生中断后，通过中断响应函数从寄存器中读取 x、y 坐标数据，并使用操作系统预置的 input 设备接口向上层软件汇报事件。

- 设备树与驱动开发：介绍 Linux 内核中设备的树状结构，新设备驱动开发只需找到对应分支节点实例化，并按要求填写数据格式。但设备树可能无法涵盖所有设备，如 2008 年 Multi touch 设备出现时，原有的设备树无法支持，导致系统震荡和调整。

