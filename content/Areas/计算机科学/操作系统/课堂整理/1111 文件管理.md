---
title: "1111｜文件管理（课堂整理）"
tags:
  - 操作系统
  - 课堂整理
  - 文件系统
lectureDate: "2025-11-11"
---

相关：[[../课堂/os week10 1111 文件管理]]

本次会议围绕计算机领域的并发与并行计算、内存一致性模型、文件系统设计及性能提升等内容展开，说话人2结合双十一、春节抢票等实际场景，深入讲解相关概念、原理和技术，分析了存在的问题及解决方案，内容如下：

- **并发与并行计算**

- **并发场景与临界区问题**

- 并发场景凸显：说话人2指出，双十一和春节抢票等场景下，大量用户同时关注同一件商品或车票，并发问题显著。如双十一时，数以万计的人同时对商品下订单，甚至同一类商品的下单人数超过百万级。

- 临界区需串行操作：在这些场景中，临界区问题变得格外重要。例如抢单、抢火车票、抢食堂最后一份饭时，商品的票面余额或剩余份数必须串行递减，即一个一个地处理，以保证数据的准确性和一致性。

- **并行计算的发展与重要性**

- 并行计算的起源：由于硬件发展逼近边缘，无法制造出更高主频的电子器件，如无法做出 5 倍运算速度的加法器或乘法器，只能采用多个加法器和乘法器并行工作的方式。因此，程序能否并行化实现成为考验程序性能的重要因素。

- 并行计算的关键问题：并行计算中有两个关键问题需要解决。一是在并行课程中，要找到没有依赖的数据，让它们各自开展运算，例如将冒泡排序改为归并或快速排序；二是在操作系统课中，要处理不能完全并行的情况，如抢单、抢票等场景，需要让有需求的人排队，制造串行世界。

- **锁机制的优化**

- 锁机制的基本原理：锁机制是解决并发问题的重要手段。一开始，锁机制会先尝试做 spinlock 或 test and set，如果成功则一条指令结束操作；若不成功，再进行争抢；若实在抢不到，才去内存里休眠。

- 锁机制的优化策略：为了提高锁机制的性能，进行了多种优化。例如，将锁拆成两半，先做 fast pass，即 test and set，成功则继续，不成功再进行后续操作；还采用了华为的 Numa aware lock，让重试的内存最好在本地，减少对其他核心的干扰；神威太湖之光上的 PLOG 可轻松替换锁的实现，但一般情况下不能轻易替换锁的实现，因为这涉及与其他程序的约定。

- 分支预测优化：在优化程序时，可给分支预测器提示，将大概率执行的分支指令排在下面，提高 cache 命中率，减少跳转操作，从而提高程序运行速度。

- **内存一致性模型**

- **内存一致性模型的概念与重要性**

- 概念解释：内存一致性模型（memory consistency model）处于组成原理、体系结构、编译器和操作系统的交叉地带，在很多书籍中被错误地翻译成 “一致性”，说话人2认为应翻译为 “保序性”，它描述的是 CPU 顺序发出的指令到达内存的顺序情况。

- 重要性体现：该模型在大量系统设计中都有体现，如编译时变量赋值顺序的交换、组成原理中的乱序执行、数据传输过程中的乱序风险等，这些都会影响程序的正确性和性能。

- **不同体系结构的内存一致性模型**

- 国产处理器：国产处理器大多采用 weak consistency model，即对指令到达内存的顺序没有任何期待，可能出现各种乱序情况。

- X86 处理器：X86 处理器采用 total sequential order（TSO）模型，虽然在执行过程中指令可能是乱序的，但最终到达内存时会变成串行，保证了指令的顺序性。

- **内存一致性模型导致的问题及解决方案**

- 软件移植问题：由于不同体系结构的内存一致性模型不同，在软件移植过程中会出现问题。例如，在 X86 计算机上验证多次都没问题的程序，移植到国产软件上时，可能会有 1/10,000 的概率崩溃。

- 解决方案参考：说话人2推荐了《memory consistent and CACHE Coherence》一书，该书清晰地讲解了各种一致性和连贯性问题，对解决相关问题有一定的参考价值。同时，在软件移植过程中，可通过添加 fence 或 barrier 指令来保证程序按照顺序到达内存，但这会牺牲大量性能。

- **文件系统设计**

- **文件系统的作用与结构**

- 屏蔽差异提供接口：文件系统的重要作用是屏蔽硬件和数据组织的差异，为用户提供一套统一的接口，如 open、read、write、close 等。

- 常见文件系统结构：说话人2介绍了三种常见的文件系统结构。一是 FAT 文件系统，采用链表结构，是比尔盖茨的起家之道；二是 Linux、Unix 等系统使用的文件系统，采用树结构；三是 Google 的 GFS 文件系统，以磁道为单位进行分配。

- **文件与文件夹的设计原理**

- 文件的组织方式：文件可以用链表或树来组织，线性表存储方便，树查找方便。文件名只是对数据的助记符，不是文件内容的一部分，可放在文件夹里记录。

- 文件夹的作用与结构：文件夹是文件的分类方式，是为了拟合人类思维模式而设计的树状结构。它记录了文件的表头或树根信息，本身也是一个文件，存储在磁盘上。文件夹的设计可以帮助用户更好地管理和查找文件。

- **文件系统设计的优化与常见操作**

- 数据结构选择：在设计文件夹时，需要考虑使用合适的数据结构来描述文件夹下的文件和文件夹列表。由于该列表需要经常被读取、操作、插入和删除，可选择数组或链表等数据结构。同时，可根据文件名、修改时间等元数据对列表进行排序，排序方式可在磁盘整理或内存读取时进行选择。

- 编程中的文件操作：在编程中，常用的文件操作是通过给出文件路径名来进行的，如 “open root/user/sbin/RM -RF /” 命令。在查找文件时，需要从路径中找到对应的文件夹表，再从表中找到文件对应的链表表头或树的树根。

- 文件系统设计的新思路：文件系统的设计一直在不断变化，如 2021 年一篇 fast 上的顶会论文提出的 hashfs，直接用哈希表将文件路径名映射到磁盘上的位置，实现了 O(1) 的文件读取速度。

- **文件系统性能提升**

- **提升磁盘性能的思路**

- 内存缓冲：提升磁盘性能可通过内存缓冲的方式，减少与磁盘的交互。磁盘本身自带缓存，如购买磁盘或 SSD 时提到的 8M、16M 等缓存，对磁盘的读写操作会先落到这里，再慢慢写回磁盘。同时，CPU 控制的内存也可缓存一部分数据，分为读缓存和写缓存。读缓存不脏，可在不需要时扔掉；写缓存不能轻易扔掉，需找时间写回磁盘。

- 制造更快设备：制造更快的设备是提升磁盘性能的另一种思路，但目前实现难度较大。

- **内存缓冲的相关问题**

- IO order 问题：内存缓冲会带来 IO order 问题，即写进 CACHE 里的数据何时被刷回到磁盘取决于 CACHE 的替换策略，可能会出现数据写入顺序与预期不一致的情况。例如，在数据库操作中，checkpoint 记录数据状态时，无法确定数据是否已写完。可通过系统调用 SYNC 来解决，但该操作会导致系统产生秒级卡顿。

- 预取器应用：CACHE 还可进行预取操作，预测程序员对文件内容的访问行为，提前将数据取到内存中。但预取器的预测效果在不同领域差异较大，在播放器等顺序访问场景中效果较好，在数据库领域效果不佳。操作系统采用启发式逻辑调整预取长度，根据用户使用情况决定下一次预取策略。

- **NVM 技术及其问题**

- NVM 技术特点：NVM（nonvolatile memory 或 persistent memory）是一种掉电不丢失数据的内存，读写速度与内存几乎相当，存储容量大。它既可以像内存一样直接进行 read 和 write 操作，又具有存储功能。

- 面临的问题：由于 NVM 本身特性，配置 CACHE 可能不再必要，但这会带来新问题，如无法像有配置 CACHE 时那样选择不写回数据。此外，该技术因成本高、性能不如传统内存等原因，已不再是研究热点，英特尔也放弃了该技术线。

- **其他相关内容**


- **磁盘损坏与数据恢复**：当磁盘的文件控制块或卷控制块坏掉时，并非无法恢复。只要蓝色的文件目录节点还在，可通过文件系统扫描找到所有文件，构建文件树。数据恢复行业利用破损数据猜测原数据样子，但收费较高，需根据数据重要性决定是否恢复。

- **文件打开与操作**

- 文件打开的作用：open 文件的过程是找到文件链表的表头或树的树根，并通知操作系统接下来要对该文件进行操作。操作系统会创建一张打开文件表，记录文件在磁盘中的位置和文件指针信息。

- 多进程操作文件：多个进程可以同时打开一个文件，但对于文件指针的共享问题需要考虑。操作系统通过打开文件表和进程打开表来管理文件的打开和关闭，不同文件系统和操作系统对多进程操作文件的保障机制不同，如 Windows 采用强制锁，Linux 则让用户自行协商。
