

- **操作系统知识回顾**

- **设备转换原理**

- 物理到数字转换：上节课讲解了设备从物理世界到数字世界的转换过程，如电容屏、电阻屏将物理位置转化为坐标和寄存器信号传入CPU，让学生了解做传感器、电路和机械结构的人为此付出的努力。

- 操作系统分层设计：操作系统为避免为每款设备从零开始写代码，会对软件分层，对计算机硬件进行设计，与教科书内容可能不完全相同。

- **硬件发展对软件的影响**

- IO读写的抛弃：由于硬件设计中IO读和IO写的硬件逻辑与内存读写重复，硬件人员将其抛弃，导致软件设计做出改动。

- 段机制的舍弃：说话人1请教龙芯总设计师胡伟武教授得知，段机制和页机制在硬件设计上功能重复，且硬件资源稀缺，所以除80386外的处理器都抛弃了段机制，Linux系统为适配各种处理器只用页机制，而Windows只对80386体系负责，既有段又有页。

- **设备与CPU通信**

- 适配器的作用：现在绝大部分外设通过适配器连接到计算机，如磁盘、U盘、蓝牙等都有各自的总线适配器，CPU通过USB主控器与这些设备通信。

- 数据传输细节：以U盘为例，介绍了USB协议之间的信息交换和数据传输过程，以及中断发生时数据的位置和处理方式。

- **操作系统与设备交互**

- **抽象层的引入**

- 解决设备交互问题：为解决操作系统与多种设备复杂交互的问题，可加抽象层，将设备归类，如扫码枪被归为键盘一类，借助键盘接口传输数据。

- 设备分类的演变：早期Linux设计者将设备分为块设备和字符设备，后续不断有新设备出现，如Multi touch设备导致Linux系统设备分类发生裂变，新增MT分类。

- **数据从内核态到用户态的传输**

- 系统调用的作用：设备采集的数据在内核态，需特定系统调用将数据从内核态搬运到用户态，如Linux借用文件系统接口，通过read和write操作实现数据交换。

- IO control系统调用：对于设备的专用命令传输，扩展了IO control系统调用，可向设备发送读、写或改变状态等命令。

- **热插拔设备管理**

- uevent机制的原理：热插拔设备插入时，系统需为其创建虚拟文件，Linux采用uevent机制，借助网络socket接口由内核通知用户态应用程序，上层有专门进程负责创建虚拟文件和管理设备。

- 系统设计的考量：这种设计是Linux系统图省事的做法，但形成了经典设计，学生可观察系统中uevent打头的进程，杀死该进程后热插拔设备将无法正常使用。



- **设备原理分析**

- **磁盘设备**

- 磁盘技术变革：介绍了磁盘的柱面、磁道和数据传输概念，以及磁盘的斜进技术和扇区交错编号等小技巧，这些技术可提高磁盘读取效率。

- 商业秘密：现在磁盘扇区的划分已成为商业秘密，不再公开。

- **光驱设备**

- 读写原理：光驱通过激光光头读写光盘，读操作时根据光的反射情况判断数据，写操作时用强光灼烧光盘改变反射特性，光盘数据只能修改一次，被称为CD ROM。

- 转速特点：为保证固定的读取速率，光驱电机转速在读取光盘内外圈时不同，外圈转速慢，内圈转速快，使用时会产生不同的噪声频率。

- **U盘（Flash）设备**

- 存储原理：常见的nandflash通过将电子隔离在特定区域实现数据存储，充电时电子穿过山格，放电时电子通过短路释放，存储有年限，数据会慢慢丢失。

- 读写操作：读操作以块为单位，写操作从0变成1需要高电压和长时间，为均摊充电时间，引入擦除块概念；放电操作速度快，但写操作有条件限制，需确保数据全为1。

- 容量差异原因：U盘实际可用容量小于标称容量，原因包括硅介质不可靠，需要预留一定比例的块用于替换坏块，以及制造和操作系统对容量计算单位的差异。

- 文件系统设计：介绍了诺基亚的ubifs文件系统，通过管理全一的块列表，提高写入性能并避免在同一块上频繁擦写，该设计已被纳入很多SSD硬件设计。

- **显示器设备**

- frame buffer原理：显示器有一块对应的内存区frame buffer，屏幕上的像素与内存区的数据一一对应，显示控制器周期性地将内存数据刷新到屏幕上。

- GPU的作用：由于图形绘制计算复杂且并行度高，出现了专门的GPU负责对frame buffer进行操作，现在GPU也用于神经网络训练等通用计算。

- **操作系统上电与运行**

- **上电过程**

- BIOS的作用：CPU上电时先执行BIOS代码，BIOS用汇编语言写成，按照IBM兼容机协议探测硬件状态，找到磁盘和内存的位置，将磁盘的第一个扇区（MBR）读到内存里。

- MBR和VBR的功能：MBR记录磁盘分区表，VBR记录文件系统加载代码，操作系统通过MBR和VBR逐步加载到内存中。

- UEFI技术：约15年前出现的UEFI技术是一个文件系统的识别和读取器，可直接探测分区的文件系统，找到操作系统文件并读取，解决了BIOS设计过于简单的问题。

- **操作系统运行状态**

- 内存占用：操作系统加载到内存后，占据特定的物理内存区域和虚拟地址空间，内核空间存放中断向量服务、调度器、内存管理等内容，用户空间存放应用程序。

- 用户视角的作用：在用户眼中，操作系统提供用户界面，包括命令行和图形界面，用户可通过命令管理系统资源、访问其他设备，还可安装应用程序，借助操作系统API访问硬件资源。

- **系统资源管理与性能评估**

- **系统资源获取**

- 虚拟地址空间获取方式：通过new、MMAP等系统调用可从系统中获取可用的虚拟地址空间，MMAP得到的是有名页，与文件内容对应，new得到的是无名页，用户动态申请的内存。

- 页面置换优先级：当内存有压力时，操作系统会优先扔掉有名页，因为踢出有名页只需检查是否脏页，而踢出无名页需要磁盘写回。

- **性能评估指标**

- CACHE命中率：通过矩阵乘法说明操作系统运行代价可通过CACHE命中率观测，合理改变运算顺序可降低CACHE失效率，提高系统运行时间，用GOPS指标评测矩阵运算效率。

- 加速比：线程投入对程序性能的影响用加速比评估，当线程数量超过平台核心数时，加速比会下降，因为会产生无谓的上下文切换和线程对CPU的争抢。

- NPU或GPU运算代价：使用NPU或GPU运算时，操作系统需要通过CS call进行数据传输和状态查看，运算量较小时，传输时间占比大，可能不值得使用。

- **进程与文件系统相关**

- **进程退出与内存回收**：进程退出时，其申请的内存需由创建者进程调用wait系统调用进行回收，否则内存无法释放。

- **文件系统读写问题**

- 数据保序性问题：文件系统读写中存在数据保序性问题，整个存储栈中没有一个环节能保证数据顺序，三星曾提出解决方案，但7年后仍未投入生产。

- 文件删除原理：删文件只是将文件标记为不用，并未真正从磁盘上删除，扫描被标记删除的数据可查看硬盘曾经的使用情况。

- **关机过程**：关机时，开机创建的第一个进程负责响应关机操作，先通知所有程序退出，若程序不退出则发起sync强制杀死进程，然后将配置、cache和buffer写回磁盘，最后设备断电。